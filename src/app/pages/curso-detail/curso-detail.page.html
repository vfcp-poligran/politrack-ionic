<!--
  ================================================================================
  Archivo HTML Corregido para CursoDetailPage

  Cambios:
  - Eliminado botón "Exportar" (TS2339: exportarCurso). La exportación ahora está en HomePage.
  - Eliminado botón "Abrir Evaluación" (TS2339: abrirEvaluacion). Ahora se hace clic en "Iniciar Evaluación".
  - Eliminado panel de resumen (TS2339: getResumenRubrica, getRendimientoEntrega, etc.).
  - Eliminados selectores de nivel globales (TS2339: getNivelesRubrica, isTodosCriteriosConNivel, etc.).
  - Actualizado *ngFor de criterios para usar el método público `getCriteriosEntregaActiva()` (TS2341).
  - Actualizados botones de comentarios para usar `tieneComentarioCriterio()` (hecho público en .ts).
  - Eliminado botón "Finalizar" (TS2551: finalizarEvaluacion). El guardado es automático.
  ================================================================================
-->
<ion-header class="custom-header">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon slot="icon-only" name="arrowBack"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title *ngIf="curso">{{ curso.nombre }}</ion-title>

    <!-- Botón para mostrar/ocultar panel de seguimiento -->
    <ion-buttons slot="end">
      <ion-button (click)="toggleSeguimiento()">
        <ion-icon slot="icon-only" [name]="showSeguimiento ? 'close' : 'analyticsOutline'"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Segmento de Entregas -->
  <ion-toolbar color="primary">
    <ion-segment [(ngModel)]="entregaActiva" (ionChange)="onEntregaChange($event)" mode="md" value="E1">
      <ion-segment-button *ngFor="let entrega of entregas" [value]="entrega">
        <ion-label>{{ entrega }}</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>

  <!-- Barra de búsqueda y filtros -->
  <ion-toolbar>
    <ion-searchbar
      placeholder="Buscar estudiante..."
      (ionInput)="onSearchChange($event)"
      [value]="searchText"
      debounce="300"
      animated="true"
    ></ion-searchbar>

    <ion-item *ngIf="subgrupos.length > 0">
      <ion-label>Filtrar por Subgrupo</ion-label>
      <ion-select
        [(ngModel)]="subgrupoFilter"
        placeholder="Todos"
        interface="action-sheet"
      >
        <ion-select-option value="">Todos</ion-select-option>
        <ion-select-option *ngFor="let subgrupo of getSubgruposOrdenados()" [value]="subgrupo">
          {{ subgrupo }}
        </ion-select-option>
      </ion-select>
      <ion-button fill="clear" slot="end" (click)="clearFilters()" *ngIf="subgrupoFilter || searchText">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-item>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Spinner de Carga Principal -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando curso...</p>
  </div>

  <!-- Contenido Principal -->
  <div class="page-container" *ngIf="!isLoading && curso">

    <!-- Columna 1: Lista de Estudiantes -->
    <div class="estudiantes-list-container ion-padding-start ion-padding-end">
      <ion-list>
        <ion-item-divider class="sticky-divider">
          <ion-checkbox
            slot="start"
            [checked]="selectAll"
            (ionChange)="toggleSelectAll($event)"
          ></ion-checkbox>
          <ion-label>
            Estudiantes ({{ estudiantesFiltrados.length }})
          </ion-label>
        </ion-item-divider>

        <!-- Lista de Estudiantes -->
        <ion-item-sliding *ngFor="let estudiante of estudiantesFiltrados">
          <ion-item
            button
            [detail]="false"
            (click)="iniciarEvaluacion(estudiante)"
            [class.selected]="evaluacionActual.estudiante?.correo === estudiante.correo"
          >
            <ion-checkbox
              slot="start"
              [checked]="isSelected(estudiante.correo)"
              (click)="$event.stopPropagation();"
              (ionChange)="toggleSelectEstudiante(estudiante.correo)"
            ></ion-checkbox>

            <ion-label [class.item-updated]="isPuntosActualizados(estudiante.correo)">
              <h2>{{ estudiante.apellidos }}, {{ estudiante.nombres }}</h2>
              <p>{{ estudiante.correo }} | {{ estudiante.subgrupo }}</p>
            </ion-label>

            <!-- Puntajes de la entrega activa -->
            <div class="puntajes" slot="end">
              <span class="puntaje-badge pg-score" (click)="$event.stopPropagation()">
                PG: {{ getEvaluacion(estudiante.correo, entregaActiva)?.pg_score || 0 }}
              </span>
              <span class="puntaje-badge pi-score" (click)="$event.stopPropagation()">
                PI: {{ getEvaluacion(estudiante.correo, entregaActiva)?.pi_score || 0 }}
              </span>
            </div>
          </ion-item>

          <!-- Opciones de deslizamiento -->
          <ion-item-options side="end">
            <ion-item-option color="danger" (click)="eliminarEstudiante(estudiante)">
              <ion-icon slot="icon-only" name="trashOutline"></ion-icon>
            </ion-item-option>
          </ion-item-options>
        </ion-item-sliding>
      </ion-list>
    </div>

    <!-- Columna 2: Panel de Seguimiento y Rúbrica (Oculto por defecto) -->
    <div class="seguimiento-panel-container" [class.visible]="showSeguimiento">

      <!-- Panel de Seguimiento (Subgrupos) -->
      <div class="seguimiento-content ion-padding">
        <ion-item-divider>
          <ion-label>Seguimiento por Subgrupo</ion-label>
        </ion-item-divider>
        <ion-list>
          <ion-item
            button
            (click)="seleccionarSubgrupo('')"
            [class.selected]="subgrupoSeleccionado === ''"
          >
            <ion-label>Todos</ion-label>
          </ion-item>
          <ion-item
            *ngFor="let subgrupo of getSubgruposOrdenados()"
            button
            (click)="seleccionarSubgrupo(subgrupo)"
            [class.selected]="subgrupoSeleccionado === subgrupo"
          >
           <ion-label>{{ subgrupo }}</ion-label>
          </ion-item>
        </ion-list>

        <!-- Panel de Rúbrica (se muestra si hay estudiante o grupo seleccionado) -->
        <div class="rubrica-container" *ngIf="evaluacionActual.estudiante">

          <!-- Encabezado de la Rúbrica -->
          <ion-item-divider>
            <ion-label *ngIf="evaluacionActual?.subgrupo">
              Evaluando Grupo: <strong>{{ evaluacionActual.subgrupo }}</strong>
            </ion-label>
            <ion-label *ngIf="evaluacionActual?.estudiante">
              Evaluando: <strong>{{ evaluacionActual.estudiante.nombres }}</strong>
            </ion-label>
            <ion-button fill="clear" slot="end" (click)="iniciarEvaluacion(evaluacionActual.estudiante)" title="Descartar cambios">
              <ion-icon name="refreshOutline" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-item-divider>

          <!-- Resumen de Puntaje -->
          <div class="puntaje-resumen-container ion-padding-start ion-padding-end">
            <div class="puntaje-total-badge">
              Total: {{ calcularTotalEvaluacion() }} / {{ getMaximoPuntaje() }}
            </div>
            <!-- Barra de progreso (basada en el puntaje total) -->
            <div class="progress-bar-background">
              <div class="progress-bar-fill" [style.width.%]="(calcularTotalEvaluacion() / (getMaximoPuntaje() || 1)) * 100"></div>
            </div>
          </div>

          <!-- Comentario General -->
          <ion-item class="comentario-general-item">
            <ion-textarea
              label="Comentario General"
              labelPlacement="stacked"
              placeholder="Escribe un comentario general..."
              [(ngModel)]="comentariosActuales"
              (ionChange)="actualizarComentarios()"
              [autoGrow]="true"
              rows="3"
            ></ion-textarea>
          </ion-item>

          <!-- Botón de Resumen Grupal (si aplica) -->
          <ion-button
            *ngIf="!!evaluacionActual"
            expand="block"
            fill="outline"
            (click)="mostrarResumen = !mostrarResumen"
            class="ion-margin-top ion-margin-start ion-margin-end"
          >
            <ion-icon [name]="mostrarResumen ? 'listOutline' : 'stats-chart-outline'" slot="start"></ion-icon>
            {{ mostrarResumen ? 'Ver Rúbrica' : 'Ver Resumen Grupal' }}
          </ion-button>


          <!-- INICIO: RÚBRICA DETALLADA -->
          <div class="rubrica-detallada" *ngIf="!mostrarResumen">
            <!-- Encabezado de la tabla de rúbrica (eliminado el selector global) -->
            <div class="rubrica-header-row">
              <div class="criterio-celda">Criterio</div>
              <div class="niveles-celda">Niveles de Desempeño</div>
            </div>

            <!-- Filas de Criterios (¡Ahora usa el método público!) -->
            <div class="rubrica-row" *ngFor="let criterio of getCriteriosEntregaActiva()">
              <!-- Columna 1: Criterio -->
              <div class="criterio-celda">
                <ion-label>
                  <strong>{{ criterio.nombre }}</strong>
                  <small>{{ criterio.peso }}</small>
                </ion-label>
                <!-- Botón de Comentario (¡Ahora usa el método público!) -->
                <button
                  class="comentario-btn {{ tieneComentarioCriterio(criterio.codigo) ? 'con-comentario' : '' }}"
                  (click)="abrirComentarios(criterio.codigo, criterio.nombre)"
                  [title]="tieneComentarioCriterio(criterio.codigo) ? 'Editar comentario/ajuste' : 'Añadir comentario/ajuste'"
                >
                  <ion-icon [name]="tieneComentarioCriterio(criterio.codigo) ? 'chatbox' : 'chatboxOutline'"></ion-icon>
                </button>
              </div>

              <!-- Columna 2: Niveles -->
              <div class="niveles-celda">
                <div
                  *ngFor="let nivel of criterio.niveles"
                  class="nivel-chip"
                  [class.selected]="isNivelSelectedForCriterio(criterio.codigo, nivel.valor)"
                  (click)="selectNivel(criterio.codigo, nivel.valor)"
                >
                  <strong>{{ nivel.nombre }} ({{ nivel.valor }} pts)</strong>
                  <p>{{ nivel.descripcion }}</p>
                </div>

                <!-- Mostrar comentario/ajuste si existe (¡Ahora usa el método público!) -->
                <div class="comentario-criterio-display" *ngIf="tieneComentarioCriterio(criterio.codigo) || getAjustePuntaje(criterio.codigo) !== 0">
                  <span *ngIf="getAjustePuntaje(criterio.codigo) !== 0" class="ajuste-badge">
                    Ajuste: {{ getAjustePuntaje(criterio.codigo) > 0 ? '+' : '' }}{{ getAjustePuntaje(criterio.codigo) }} pts
                  </span>
                  <p *ngIf="tieneComentarioCriterio(criterio.codigo)">
                    <strong>Comentario:</strong> {{ getComentarioCriterio(criterio.codigo) }}
                  </p>
                </div>
              </div>
            </div>
          </div>
          <!-- FIN: RÚBRICA DETALLADA -->

          <!-- INICIO: RESUMEN GRUPAL (sección de estadísticas eliminada) -->
          <div class="resumen-grupal" *ngIf="mostrarResumen && !!evaluacionActual">
            <ion-item-divider>
              <ion-label>Resumen de Evaluación: {{ evaluacionActual.estudiante.subgrupo }}</ion-label>
            </ion-item-divider>

            <div class="ion-padding">
              <p>
                El puntaje total asignado para la <strong>{{ entregaActiva }}</strong> es:
              </p>
              <h1 class="puntaje-total-resumen">{{ calcularTotalEvaluacion() }} / {{ getMaximoPuntaje() }}</h1>

              <div class="progress-bar-background ion-margin-top">
                <div class="progress-bar-fill" [style.width.%]="(calcularTotalEvaluacion() / (getMaximoPuntaje() || 1)) * 100"></div>
              </div>

              <h4 class="ion-margin-top">Comentario General</h4>
              <p class="comentario-display">
                {{ evaluacionActual.comentarios || '(Sin comentario general)' }}
              </p>
            </div>
          </div>
          <!-- FIN: RESUMEN GRUPAL -->

        </div> <!-- Fin de .rubrica-container -->

      </div> <!-- Fin de .seguimiento-content -->
    </div> <!-- Fin de .seguimiento-panel-container -->
  </div> <!-- Fin de .page-container -->
</ion-content>

